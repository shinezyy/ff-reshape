From 80ff495524a736c698151c33c7fc061cd00eff7c Mon Sep 17 00:00:00 2001
From: Zhou Yaoyang <shinezyy@qq.com>
Date: Thu, 9 Jul 2020 12:19:54 +0800
Subject: [PATCH 09/13] fixed loop buffer entry with other sizes

Change-Id: I68e6ceecb7284ce8563d5577905c5b7a2a6e5706
---
 src/cpu/o3/fetch_impl.hh | 7 ++-----
 1 file changed, 2 insertions(+), 5 deletions(-)

diff --git a/src/cpu/o3/fetch_impl.hh b/src/cpu/o3/fetch_impl.hh
index 47617a01e..66b07e6c8 100644
--- a/src/cpu/o3/fetch_impl.hh
+++ b/src/cpu/o3/fetch_impl.hh
@@ -1283,7 +1283,7 @@ DefaultFetch<Impl>::fetch(bool &status_change)
     TheISA::MachInst *cacheInsts =
         reinterpret_cast<TheISA::MachInst *>(fetchBuffer[tid]);
 
-    const unsigned numInsts = fetchBufferSize / instSize;
+    unsigned numInsts = fetchBufferSize / instSize;
     unsigned blkOffset =
         (fetchAddr - fetchBufferPC[tid]) / instSize;
 
@@ -1335,10 +1335,7 @@ DefaultFetch<Impl>::fetch(bool &status_change)
                         lbufStartPC, loop_branch_pc, fetchAddr, blkOffset, instSize);
                 unsigned lbuf_entry_insts = lbuf->entrySize / instSize;
                 cacheInsts = reinterpret_cast<TheISA::MachInst *>(foundLine);
-
-                if (blkOffset > lbuf_entry_insts) {
-                    break;
-                }
+                numInsts = lbuf_entry_insts;
 
             } else if (!fetchBufferValid[tid] ||
                 fetchBufferBlockPC != fetchBufferPC[tid]) {
-- 
2.29.2

